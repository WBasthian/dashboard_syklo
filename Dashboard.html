<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Seguimiento de Operaciones</title>
    <style>
        /* ESTILOS EXISTENTES DE LA TABLA DE OPERACIONES */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #cbd5e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
            --card-hover: #f7fafc;
        }

        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --header-bg: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            --card-hover: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section {
            display: none;
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .header {
            background: var(--header-bg);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1::before {
            content: "üìä";
            font-size: 1.5rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .controls {
            padding: 25px 30px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            background: var(--bg-secondary);
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-primary);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .date-selector label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        input[type="date"] {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        input[type="date"]:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .add-btn {
            background: linear-gradient(135deg, var(--success) 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
        }

        .divider {
            width: 2px;
            height: 30px;
            background: var(--border-color);
        }

        .wally-btn {
            background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%);
            color: white;
            border: none;
            padding: 10px 15px; /* Ajustado para el header */
            border-radius: 25px; /* Ajustado para el header */
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px); /* A√±adido para consistencia con theme-toggle */
        }

        .wally-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(159, 122, 234, 0.3);
            background: linear-gradient(135deg, #a78bfa 0%, #7f64e3 100%); /* Ligeramente m√°s oscuro al hover */
        }

        .back-btn {
            background: linear-gradient(135deg, var(--text-muted) 0%, var(--text-secondary) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
        }

        #historySelector {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 200px;
        }

        #historySelector:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .summary {
            background: var(--bg-secondary);
            padding: 25px 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .summary-item {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .summary-item:hover {
            transform: translateY(-4px);
        }

        .summary-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-value.profit {
            color: var(--success);
        }

        .table-header {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-bottom: 2px solid var(--border-color);
            text-align: center;
        }

        .table-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 16px 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            font-size: 13px;
            color: var(--text-primary);
        }

        tr:hover {
            background-color: var(--card-hover);
        }

        .compra {
            background: linear-gradient(90deg, rgba(72, 187, 120, 0.1) 0%, rgba(72, 187, 120, 0.05) 100%) !important;
            border-left: 4px solid var(--success);
        }

        .venta {
            background: linear-gradient(90deg, rgba(245, 101, 101, 0.1) 0%, rgba(245, 101, 101, 0.05) 100%) !important;
            border-left: 4px solid var(--danger);
        }

        .status-completado {
            background: var(--success);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-en-curso {
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-en-disputa {
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .edit-btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .delete-btn:hover {
            background: #e53e3e;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            padding: 0;
            border-radius: 20px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--header-bg);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .form-sections {
            display: grid;
            gap: 30px;
        }

        .form-section {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid var(--info);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input, .form-group select {
            padding: 14px 16px;
            font-size: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            transform: translateY(-2px);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px 30px 30px;
            background: var(--bg-secondary);
            border-radius: 0 0 20px 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--info) 0%, #3182ce 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-green {
            background: linear-gradient(135deg, var(--success) 0%, #38a169 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-green:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.3);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .calculated {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(72, 187, 120, 0.05) 100%) !important;
            border-color: var(--success) !important;
            font-weight: 600;
            color: var(--success);
        }

        .disabled-field {
            background: var(--bg-tertiary) !important;
            color: var(--text-muted) !important;
            cursor: not-allowed;
        }

        /* Wally Tech Section Specific Styles */
        .wally-header h1::before {
            content: "üí±";
        }

        .wally-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .wally-column {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
        }

        .wally-column.compra {
            border-top: 4px solid var(--success);
        }

        .wally-column.venta {
            border-top: 4px solid var(--danger);
        }

        .wally-column h3 {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            color: white;
        }

        .wally-column.compra h3 {
            background: var(--success);
        }

        .wally-column.venta h3 {
            background: var(--danger);
        }

        .wally-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .wally-table-container table {
            min-width: 100%;
        }

        .wally-summary {
            grid-column: span 2;
            background: linear-gradient(135deg, #9f7aea 0%, #667eea 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .wally-summary h3 {
            margin-bottom: 15px;
        }

        .wally-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .wally-summary-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                margin: 10px;
            }
            
            .section {
                border-radius: 12px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .summary {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 98%;
                margin: 10px;
            }

            .wally-table {
                grid-template-columns: 1fr;
            }

            .wally-summary {
                grid-column: span 1;
            }
        }

        /* Solo la secci√≥n de LOTE tendr√° scroll vertical */
        .lote-scroll {
            max-height: 80px;
            overflow-y: auto;
            overflow-x: hidden;
            white-space: normal;
            word-break: break-word;
            padding: 2px 4px;
        }

        /* Evita que la fila "estire" el contenido hacia el centro */
        #tablaOperaciones td {
            vertical-align: top;
        }

        .toggle-info-btn {
            background: linear-gradient(135deg, var(--info) 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .toggle-info-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.3);
            background: linear-gradient(135deg, #4299e1 0%, #2b6cb0 100%);
        }

        .toggle-info-btn span {
            transition: transform 0.3s ease;
        }

        /* Estilo para que el input se vea como los otros valores */
        .wally-input {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            border: none;
            background: transparent;
            color: var(--text-primary);
            width: 100px;
            outline: none;
            transition: all 0.3s ease;
        }

        /* Cuando est√° editable */
        .wally-input:not([readonly]) {
            border-bottom: 2px solid var(--info);
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 2px 4px;
        }

        /* Bot√≥n de editar */
        .edit-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .edit-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* ==== ESTILOS DEL CENTRO DE OPERACIONES IA ==== */
        #aiOperationsCenter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        #aiToggleBtn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        #aiToggleBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        }

        #aiToggleBtn.has-alerts {
            animation: pulse-alert 2s infinite;
        }

        #aiToggleBtn.critical {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            animation: pulse-critical 1s infinite;
        }

        #aiNotificationBadge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        @keyframes pulse-alert {
            0% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(237, 137, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0); }
        }

        @keyframes pulse-critical {
            0% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(245, 101, 101, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0); }
        }

        /* Panel de Notificaciones */
        #aiPanel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 450px; /* Aumentado el ancho para mejor visualizaci√≥n */
            max-height: 600px; /* Aumentado la altura m√°xima */
            background: var(--bg-primary);
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        #aiHeader {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #aiHeader h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        #aiStatus {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: blink 2s infinite;
        }

        .status-indicator.warning { background: var(--warning); }
        .status-indicator.critical { background: var(--danger); }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        #aiNotifications {
            flex: 1;
            overflow-y: auto; /* Asegura el scroll */
            max-height: 350px; /* Ajustado para mostrar m√°s notificaciones */
            padding: 10px;
        }

        .notification-section {
            margin-bottom: 15px;
        }

        .notification-section h4 {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px; /* Aumentado el padding */
            margin-bottom: 10px; /* Aumentado el margin */
            position: relative;
            animation: slideIn 0.3s ease-out;
            transition: all 0.3s ease;
        }

        .notification:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow);
        }

        .notification.info { border-left: 4px solid var(--info); }
        .notification.success { border-left: 4px solid var(--success); }
        .notification.warning { border-left: 4px solid var(--warning); }
        .notification.danger { border-left: 4px solid var(--danger); }

        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px; /* Aumentado el margin */
        }

        .notification-title {
            font-weight: 600;
            font-size: 14px; /* Aumentado el tama√±o de fuente */
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px; /* Aumentado el gap */
        }

        .notification-time {
            font-size: 11px; /* Aumentado el tama√±o de fuente */
            color: #a0aec0;
        }

        .notification-content {
            font-size: 13px; /* Aumentado el tama√±o de fuente */
            color: var(--text-primary);
            line-height: 1.4; /* Aumentado el line-height */
        }

        .notification-metrics {
            margin-top: 10px; /* Aumentado el margin */
            padding: 10px; /* Aumentado el padding */
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px; /* Aumentado el tama√±o de fuente */
            white-space: pre-wrap; /* Permite saltos de l√≠nea en el contenido */
            word-break: break-word; /* Rompe palabras largas */
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        #aiControls {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .ai-control-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-control-btn.clear {
            background: #f7fafc;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .ai-control-btn.clear:hover {
            background: #e2e8f0;
        }

        .ai-control-btn.settings {
            background: var(--info);
            color: white;
        }

        .ai-control-btn.settings:hover {
            background: #3182ce;
        }

        /* Dashboard de m√©tricas en tiempo real */
        #aiMetrics {
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .metric-item {
            text-align: center;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .metric-label {
            font-size: 10px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-value.warning { color: var(--warning); }

        /* Responsive para el centro de operaciones */
        @media (max-width: 768px) {
            #aiPanel {
                width: 95vw;
                right: -15px;
            }
        }

        /* Ocultar scrollbar pero mantener funcionalidad */
        #aiNotifications::-webkit-scrollbar {
            width: 4px;
        }

        #aiNotifications::-webkit-scrollbar-track {
            background: transparent;
        }

        #aiNotifications::-webkit-scrollbar-thumb {
            background: rgba(160, 174, 192, 0.3);
            border-radius: 4px;
        }

        #aiNotifications::-webkit-scrollbar-thumb:hover {
            background: rgba(160, 174, 192, 0.5);
        }

        /* Estilos para el buscador y filtros */
        .filter-controls {
            display: grid; /* Cambiado a grid */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Columnas flexibles */
            gap: 15px;
            align-items: center;
            flex-wrap: wrap; /* Mantenido para compatibilidad en caso de que no quepan */
            padding: 15px 30px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
        }

        .filter-controls input[type="text"],
        .filter-controls select {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            min-width: unset; /* Eliminar min-width fijo */
            width: 100%; /* Asegurar que ocupen el 100% de su celda en el grid */
        }

        .filter-controls input[type="text"]:focus,
        .filter-controls select:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
    </style>
</head>
<body data-theme="light">
    <div class="app-container">
        <!-- Secci√≥n Principal -->
        <div id="mainSection" class="section active">
            <div class="header">
                <h1>Sistema de Seguimiento de Operaciones</h1>
                <div class="header-controls">
                    <!-- Bot√≥n Wally Tech movido aqu√≠ -->
                    <button class="wally-btn" onclick="switchToWally()">
                        üöÄ Wally Tech
                    </button>
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <span id="themeIcon">üåô</span>
                        <span id="themeText">Modo Oscuro</span>
                    </button>
                </div>
            </div>

            <div class="controls">
                <div class="date-selector">
                    <label>Fecha:</label>
                    <input type="date" id="selectedDate">
                </div>
                <button class="add-btn" onclick="openModal()">
                    + Agregar Operaci√≥n
                </button>
                <div class="divider"></div>
                <select id="historySelector" onchange="loadHistoryDate()">
                    <option value="">Ver historial por fecha</option>
                </select>
            </div>

            <div class="summary">
                <div class="summary-item">
                    <div class="summary-label">Promedio Compra VES</div>
                    <div class="summary-value" id="promCompra">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Promedio Venta VES</div>
                    <div class="summary-value" id="promVenta">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Brecha</div>
                    <div class="summary-value" id="brecha">0%</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Ganancias</div>
                    <div class="summary-value profit" id="ganancias">0 VES / 0 USDC</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Operaciones</div>
                    <div class="summary-value" id="totalOps">0</div>
                </div>
            </div>

            <div class="table-header">
                <h2>üìã Tabla de Operaciones</h2>
            </div>

            <!-- Buscador y Filtros -->
            <div class="filter-controls">
                <input type="text" id="searchOperations" placeholder="Buscar por usuario o referencia..." onkeyup="filterOperations()">
                <select id="filterOperacion" onchange="filterOperations()">
                    <option value="">Todas las Operaciones</option>
                    <option value="Compra">Compra</option>
                    <option value="Venta">Venta</option>
                </select>
                <select id="filterMetodoPago" onchange="filterOperations()">
                    <option value="">Todos los M√©todos</option>
                    <option value="Pagomovil">Pagomovil</option>
                    <option value="Banesco">Banesco</option>
                    <option value="Venezuela">Venezuela</option>
                    <option value="Bancamiga">Bancamiga</option>
                    <option value="BNC">BNC</option>
                </select>
                <select id="filterEstatus" onchange="filterOperations()">
                    <option value="">Todos los Estatus</option>
                    <option value="En Curso">En Curso</option>
                    <option value="En Disputa">En Disputa</option>
                    <option value="Completado">Completado</option>
                </select>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>USUARIO</th>
                            <th>REF</th>
                            <th>OPERACI√ìN</th>
                            <th>TASA</th>
                            <th>M√âTODO DE PAGO</th>
                            <th>Monto USDC</th>
                            <th>Monto BS</th>
                            <th>Comisi√≥n VES</th>
                            <th>TOTAL</th>
                            <th>/VES</th>
                            <th>/USDC</th>
                            <th>LOTE</th>
                            <th>ESTATUS</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="operationsTable">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Secci√≥n Wally Tech -->
        <div id="wallySection" class="section">
            <div class="header wally-header">
                <h1>Sistema Wally Tech - USD/USDC</h1>
                <div class="header-controls">
                    <button class="back-btn" onclick="switchToMain()">
                        ‚Üê Regresar
                    </button>
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <span id="themeIcon2">üåô</span>
                        <span id="themeText2">Modo Oscuro</span>
                    </button>
                </div>
            </div>

            <div class="controls">
                <div class="date-selector">
                    <label>Fecha:</label>
                    <input type="date" id="wallySelectedDate">
                </div>
                <button class="add-btn" onclick="openWallyModal()">
                    + Agregar Operaci√≥n Wally
                </button>
                <select id="wallyHistorySelector" onchange="loadWallyHistoryDate()">
                    <option value="">Ver historial por fecha</option>
                </select>
            </div>

            <div class="wally-table">
                <div class="wally-column compra">
                    <h3>COMPRA - RECIBO USDC</h3>
                    <div class="wally-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>USUARIO</th>
                                    <th>REF</th>
                                    <th>RECIBO USDC</th>
                                    <th>TASA COMPRA</th>
                                    <th>ENVIO USD</th>
                                    <th>GANANCIA EN USDC</th>
                                    <th>ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody id="wallyCompraTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="wally-column venta">
                    <h3>VENTA - RECIBO USD</h3>
                    <div class="wally-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>USUARIO</th>
                                    <th>REF</th>
                                    <th>RECIBO USD</th>
                                    <th>TASA VENTA</th>
                                    <th>ENVIO USDC</th>
                                    <th>GANANCIA EN USD</th>
                                    <th>ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody id="wallyVentaTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="wally-summary">
                    <h3>Resumen Wally Tech</h3>
                    <div class="wally-summary-grid">
                        <div class="wally-summary-item">
                            <div class="summary-label">VAL. INI. WALLY</div>
                            <div class="summary-value" style="display:flex; align-items:center; gap:8px; justify-content:center;">
                                <input type="number" id="wallyValorInicialInput" step="0.01" placeholder="0.00" 
                                    onblur="saveWallyValorInicial()" class="wally-input">
                                <button id="editWallyIniBtn" onclick="editWallyValorInicial()" style="display:none;" class="edit-icon">‚úèÔ∏è</button>
                            </div>
                        </div>
                        <div class="wally-summary-item">
                            <div class="summary-label">VAL. ACT. WALLY</div>
                            <div class="summary-value" id="wallyValorActual">0</div>
                        </div>
                        <div class="wally-summary-item">
                            <div class="summary-label">GANANCIAS USDC/USD</div>
                            <div class="summary-value" id="wallyGanancias">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para operaciones principales -->
    <div id="operationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Agregar Nueva Operaci√≥n</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-sections">
                    <!-- Informaci√≥n B√°sica -->
                    <div class="form-section">
                        <div class="section-title">
                            <span>üë§</span>
                            Informaci√≥n B√°sica
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Usuario:</label>
                                <input type="text" id="usuario" placeholder="Nombre del usuario" required>
                            </div>
                            <div class="form-group">
                                <label>Referencia:</label>
                                <input type="text" id="referencia" placeholder="N√∫mero de referencia" required>
                            </div>
                            <div class="form-group">
                                <label>Operaci√≥n:</label>
                                <select id="operacion" onchange="updateFeeField()" required>
                                    <option value="">Seleccionar operaci√≥n...</option>
                                    <option value="Compra">üìà Compra</option>
                                    <option value="Venta">üìâ Venta</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>M√©todo de Pago:</label>
                                <select id="metodoPago" onchange="updateFeeField()" required>
                                    <option value="">Seleccionar m√©todo...</option>
                                    <option value="Pagomovil">üí≥ Pagomovil</option>
                                    <option value="Banesco">üè¶ Banesco</option>
                                    <option value="Venezuela">üèõÔ∏è Venezuela</option>
                                    <option value="Bancamiga">üè¢ Bancamiga</option>
                                    <option value="BNC">üèóÔ∏è BNC</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Financiera -->
                    <div class="form-section">
                        <div class="section-title">
                            <span>üí∞</span>
                            Informaci√≥n Financiera
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Tasa de Cambio:</label>
                                <input type="number" id="tasa" step="0.01" placeholder="0.00" onchange="calculateMontoBs()" required>
                            </div>
                            <div class="form-group">
                                <label>Monto USDC:</label>
                                <input type="number" id="montoUsdc" step="0.01" placeholder="0.00" onchange="calculateMontoBs()" required>
                            </div>
                            <div class="form-group">
                                <label>Monto BS (Calculado):</label>
                                <input type="number" id="montoBs" class="calculated" placeholder="Auto-calculado" readonly>
                            </div>
                            <div class="form-group">
                                <label>Comisi√≥n VES:</label>
                                <input type="number" id="comisionVes" step="0.01" placeholder="0.00" onchange="calculateTotal()">
                            </div>
                            <div class="form-group">
                                <label>Total (Calculado):</label>
                                <input type="number" id="total" class="calculated" placeholder="Auto-calculado" readonly>
                            </div>
                            <div class="form-group">
                                <label>Estatus:</label>
                                <select id="estatus" required>
                                    <option value="">Seleccionar estatus...</option>
                                    <option value="En Curso">üîÑ En Curso</option>
                                    <option value="En Disputa">‚ö†Ô∏è En Disputa</option>
                                    <option value="Completado">‚úÖ Completado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Adicional -->
                    <button type="button" class="toggle-info-btn" onclick="toggleInfo()">
                        <span id="infoIcon">‚ñº</span> Informaci√≥n adicional
                    </button>

                    <div id="infoExtra" style="display: none;">
                        <div class="form-section">
                            <div class="section-title">
                                <span>üìã</span>
                                Informaci√≥n Adicional
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>/VES:</label>
                                    <input type="text" id="ves" placeholder="Ganancia VES">
                                </div>
                                <div class="form-group">
                                    <label>/USDC:</label>
                                    <input type="text" id="usdc" placeholder="Ganancia USDC">
                                </div>
                                <div class="form-group">
                                    <label>Lote:</label>
                                    <input type="text" id="lote" placeholder="N√∫mero de lote">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">
                    ‚úñÔ∏è Cancelar
                </button>
                <button class="btn btn-green" onclick="pasteSpecial()">
                    üìã Pegado Especial
                </button>
                <button class="btn btn-primary" onclick="saveOperation()">
                    üíæ Guardar Operaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para operaciones Wally -->
    <div id="wallyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="wallyModalTitle">Agregar Operaci√≥n Wally Tech</h2>
                <button class="close-btn" onclick="closeWallyModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-sections">
                    <div class="form-section">
                        <div class="section-title">
                            <span>üí±</span>
                            Operaci√≥n USD/USDC
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Usuario:</label>
                                <input type="text" id="wallyUsuario" placeholder="Nombre del usuario" required>
                            </div>
                            <div class="form-group">
                                <label>Referencia:</label>
                                <input type="text" id="wallyReferencia" placeholder="N√∫mero de referencia" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Operaci√≥n:</label>
                                <select id="wallyOperacion" onchange="updateWallyFields()" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Compra">üìà Compra (Recibo USDC)</option>
                                    <option value="Venta">üìâ Venta (Recibo USD)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>M√©todo:</label>
                                <select id="wallyMetodo" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Wally">üöÄ Wally</option>
                                    <option value="Syklo">‚ö° Syklo</option>
                                </select>
                            </div>
                            <div class="form-group" id="reciboUsdcGroup" style="display:none;">
                                <label>Recibo USDC:</label>
                                <input type="number" id="reciboUsdc" step="0.01" placeholder="0.00" onchange="calculateWallyCompra()">
                            </div>
                            <div class="form-group" id="reciboUsdGroup" style="display:none;">
                                <label>Recibo USD:</label>
                                <input type="number" id="reciboUsd" step="0.01" placeholder="0.00" onchange="calculateWallyVenta()">
                            </div>
                            <div class="form-group" id="tasaCompraGroup" style="display:none;">
                                <label>Tasa Compra:</label>
                                <input type="number" id="tasaCompra" step="0.001" placeholder="0.000" onchange="calculateWallyCompra()">
                            </div>
                            <div class="form-group" id="tasaVentaGroup" style="display:none;">
                                <label>Tasa Venta:</label>
                                <input type="number" id="tasaVenta" step="0.001" placeholder="0.000" onchange="calculateWallyVenta()">
                            </div>
                            <div class="form-group" id="envioUsdGroup" style="display:none;">
                                <label>Env√≠o USD (Calculado):</label>
                                <input type="number" id="envioUsd" class="calculated" readonly>
                            </div>
                            <div class="form-group" id="envioUsdcGroup" style="display:none;">
                                <label>Env√≠o USDC (Calculado):</label>
                                <input type="number" id="envioUsdc" class="calculated" readonly>
                            </div>
                            <div class="form-group" id="gananciaUsdcGroup" style="display:none;">
                                <label>Ganancia USDC (Calculada):</label>
                                <input type="number" id="gananciaUsdc" class="calculated" readonly>
                            </div>
                            <div class="form-group" id="gananciaUsdGroup" style="display:none;">
                                <label>Ganancia USD (Calculada):</label>
                                <input type="number" id="gananciaUsd" class="calculated" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeWallyModal()">
                    ‚úñÔ∏è Cancelar
                </button>
                <button class="btn btn-primary" onclick="saveWallyOperation()">
                    üíæ Guardar Operaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Centro de Operaciones IA -->
    <div id="aiOperationsCenter">
        <button id="aiToggleBtn">
            ü§ñ
            <div id="aiNotificationBadge">0</div>
        </button>
        
        <div id="aiPanel">
            <!-- Header -->
            <div id="aiHeader">
                <span>üß†</span>
                <h3>Centro de Operaciones IA</h3>
            </div>

            <!-- Estado del Sistema -->
            <div id="aiStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Sistema Activo - Monitoreando</span>
            </div>

            <!-- M√©tricas en Tiempo Real -->
            <div id="aiMetrics">
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Brecha Actual</div>
                        <div class="metric-value" id="currentGap">0%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Lotes Activos</div>
                        <div class="metric-value" id="activeLots">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Ganancia Hoy</div>
                        <div class="metric-value positive" id="dailyProfit">0 VES / 0 USDC</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Recompra Pendiente</div>
                        <div class="metric-value" id="pendingRepurchase">0 USDC</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Reventa Pendiente</div>
                        <div class="metric-value" id="pendingResale">0 USDC</div>
                    </div>
                </div>
            </div>

            <!-- Notificaciones -->
            <div id="aiNotifications">
                <!-- Las notificaciones se renderizar√°n aqu√≠ -->
            </div>

            <!-- Controles -->
            <div id="aiControls">
                <button class="ai-control-btn clear" onclick="clearNotifications()">
                    üóëÔ∏è Limpiar
                </button>
                <button class="ai-control-btn settings" onclick="toggleAISettings()">
                    ‚öôÔ∏è Config
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== VARIABLES GLOBALES Y FUNCIONES DE LA TABLA DE OPERACIONES =====
        let operations = [];
        let wallyOperations = [];
        let editingIndex = -1;
        let editingWallyIndex = -1;
        let currentDate = new Date().toISOString().split('T')[0];
        let currentWallyDate = new Date().toISOString().split('T')[0];
        let currentSection = 'main';

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('selectedDate').value = currentDate;
            document.getElementById('wallySelectedDate').value = currentWallyDate;
            loadOperations();
            loadWallyOperations();
            updateHistorySelector();
            updateWallyHistorySelector();
            loadTheme();
            loadWallyValorInicial(); // Carga el valor inicial de Wally
        });

        // Funciones de navegaci√≥n entre secciones
        function switchToWally() {
            document.getElementById('mainSection').classList.remove('active');
            document.getElementById('wallySection').classList.add('active');
            currentSection = 'wally';
            // Al cambiar a Wally, aseg√∫rate de cargar las operaciones de Wally para la fecha actual
            loadWallyOperations(); 
        }

        function switchToMain() {
            document.getElementById('wallySection').classList.remove('active');
            document.getElementById('mainSection').classList.add('active');
            currentSection = 'main';
            // Al cambiar a Main, aseg√∫rate de cargar las operaciones principales para la fecha actual
            loadOperations();
        }

        // Funciones de tema
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButtons(newTheme);
        }

        function updateThemeButtons(theme) {
            const icons = document.querySelectorAll('[id^="themeIcon"]');
            const texts = document.querySelectorAll('[id^="themeText"]');
            
            icons.forEach(icon => {
                icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            });
            
            texts.forEach(text => {
                text.textContent = theme === 'light' ? 'Modo Oscuro' : 'Modo Claro';
            });
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeButtons(savedTheme);
        }

        // Funciones del modal principal
        function openModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Agregar Nueva Operaci√≥n';
            clearForm();
            document.getElementById('operationModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('operationModal').style.display = 'none';
            clearForm();
        }

        function clearForm() {
            const form = document.getElementById('operationModal');
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('disabled-field');
                input.readOnly = false;
            });
            // Asegurarse de que la secci√≥n de informaci√≥n adicional est√© oculta al abrir el modal
            document.getElementById("infoExtra").style.display = "none";
            document.getElementById("infoIcon").textContent = "‚ñº";
        }

        // Funciones del modal Wally
        function openWallyModal() {
            editingWallyIndex = -1;
            document.getElementById('wallyModalTitle').textContent = 'Agregar Operaci√≥n Wally Tech';
            clearWallyForm();
            document.getElementById('wallyModal').style.display = 'block';
        }

        function closeWallyModal() {
            document.getElementById('wallyModal').style.display = 'none';
            clearWallyForm();
        }

        function clearWallyForm() {
            const form = document.getElementById('wallyModal');
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.value = '';
            });
            updateWallyFields();
        }

        // Funciones de c√°lculo principal
        function updateFeeField() {
            const operacion = document.getElementById('operacion').value;
            const metodoPago = document.getElementById('metodoPago').value;
            const comisionField = document.getElementById('comisionVes');
            
            if (operacion === 'Venta' || metodoPago !== 'Pagomovil') {
                comisionField.value = '0';
                comisionField.classList.add('disabled-field');
                comisionField.readOnly = true;
            } else {
                comisionField.classList.remove('disabled-field');
                comisionField.readOnly = false;
                if (operacion === 'Compra' && metodoPago === 'Pagomovil') {
                    calculateFee();
                }
            }
            calculateTotal();
        }

        function calculateMontoBs() {
            const tasa = parseFloat(document.getElementById('tasa').value) || 0;
            const montoUsdc = parseFloat(document.getElementById('montoUsdc').value) || 0;
            const montoBs = tasa * montoUsdc;
            
            document.getElementById('montoBs').value = montoBs.toFixed(2);
            
            if (document.getElementById('operacion').value === 'Compra' && 
                document.getElementById('metodoPago').value === 'Pagomovil') {
                calculateFee();
            }
            calculateTotal();
        }

        function calculateFee() {
            const montoBs = parseFloat(document.getElementById('montoBs').value) || 0;
            const fee = montoBs * 0.003;
            document.getElementById('comisionVes').value = fee.toFixed(2);
            calculateTotal();
        }

        function calculateTotal() {
            const montoBs = parseFloat(document.getElementById('montoBs').value) || 0;
            const comisionVes = parseFloat(document.getElementById('comisionVes').value) || 0;
            const total = montoBs + comisionVes;
            
            document.getElementById('total').value = total.toFixed(2);
        }

        // Funciones de c√°lculo Wally
        function updateWallyFields() {
            const operacion = document.getElementById('wallyOperacion').value;
            
            // Ocultar todos los grupos
            const groups = ['reciboUsdcGroup', 'reciboUsdGroup', 'tasaCompraGroup', 'tasaVentaGroup', 
                           'envioUsdGroup', 'envioUsdcGroup', 'gananciaUsdcGroup', 'gananciaUsdGroup'];
            
            groups.forEach(groupId => {
                document.getElementById(groupId).style.display = 'none';
            });

            if (operacion === 'Compra') {
                document.getElementById('reciboUsdcGroup').style.display = 'block';
                document.getElementById('tasaCompraGroup').style.display = 'block';
                document.getElementById('envioUsdGroup').style.display = 'block';
                document.getElementById('gananciaUsdcGroup').style.display = 'block';
            } else if (operacion === 'Venta') {
                document.getElementById('reciboUsdGroup').style.display = 'block';
                document.getElementById('tasaVentaGroup').style.display = 'block';
                document.getElementById('envioUsdcGroup').style.display = 'block';
                document.getElementById('gananciaUsdGroup').style.display = 'block';
            }
        }

        function calculateWallyCompra() {
            const reciboUsdc = parseFloat(document.getElementById('reciboUsdc').value) || 0;
            const tasaCompra = parseFloat(document.getElementById('tasaCompra').value) || 0;
            
            const envioUsd = reciboUsdc * tasaCompra;
            document.getElementById('envioUsd').value = envioUsd.toFixed(2);
            
            const gananciaUsdc = (reciboUsdc - envioUsd).toFixed(4); // Corregido: ganancia es la diferencia entre lo recibido y lo enviado
            document.getElementById('gananciaUsdc').value = gananciaUsdc;
        }

        function calculateWallyVenta() {
            const reciboUsd = parseFloat(document.getElementById('reciboUsd').value) || 0;
            const tasaVenta = parseFloat(document.getElementById('tasaVenta').value) || 0;
            
            const envioUsdc = reciboUsd * tasaVenta;
            document.getElementById('envioUsdc').value = envioUsdc.toFixed(2);
            
            const gananciaUsd = (reciboUsd - envioUsdc).toFixed(4); // Corregido: ganancia es la diferencia entre lo recibido y lo enviado
            document.getElementById('gananciaUsd').value = gananciaUsd;
        }

        // Funciones de guardado principal
        function saveOperation() {
            const operation = {
                usuario: document.getElementById('usuario').value,
                referencia: document.getElementById('referencia').value,
                operacion: document.getElementById('operacion').value,
                tasa: parseFloat(document.getElementById('tasa').value),
                metodoPago: document.getElementById('metodoPago').value,
                montoUsdc: parseFloat(document.getElementById('montoUsdc').value),
                montoBs: parseFloat(document.getElementById('montoBs').value),
                comisionVes: parseFloat(document.getElementById('comisionVes').value) || 0,
                total: parseFloat(document.getElementById('total').value),
                ves: parseFloat(document.getElementById('ves').value) || 0, // Asegurar que sea n√∫mero
                usdc: parseFloat(document.getElementById('usdc').value) || 0, // Asegurar que sea n√∫mero
                lote: document.getElementById('lote').value,
                estatus: document.getElementById('estatus').value,
                fecha: currentDate,
                timestamp: Date.now()
            };

            // Validaci√≥n
            if (!operation.usuario || !operation.referencia || !operation.operacion || 
                isNaN(operation.tasa) || isNaN(operation.montoUsdc) || !operation.metodoPago || !operation.estatus) {
                alert('Por favor, complete todos los campos obligatorios y aseg√∫rese de que los valores num√©ricos sean v√°lidos.');
                return;
            }

            if (editingIndex >= 0) {
                operations[editingIndex] = operation;
            } else {
                operations.unshift(operation);
            }

            saveOperations();
            renderTable(); // Llama a renderTable para aplicar filtros y b√∫squeda
            updateSummary();
            closeModal();
            
            // Notificar al centro de operaciones IA
            if (window.aiCenter) {
                if (editingIndex >= 0) {
                    window.notifyAIEditOperation(operation);
                } else {
                    window.notifyAINewOperation(operation);
                }
            }
        }

        async function pasteSpecial() {
            try {
                const text = await navigator.clipboard.readText();
                const refMatch = text.match(/-\s*([a-z0-9]{8})/i);
                const usuarioMatch = text.match(/Contraparte:\s*([A-Z0-9\.]+)/i);
                const montoUsdcMatch = text.match(/Monto recibido:\s*([\d\.]+)\s*USDC/i);
                const tasaMatch = text.match(/Precio:\s*([\d\.]+)/i);
                const estatusMatch = text.match(/Transacci√≥n\s+completada/i);

                if (usuarioMatch) document.getElementById("usuario").value = usuarioMatch[1];
                if (refMatch) document.getElementById("referencia").value = refMatch[1];
                if (tasaMatch) document.getElementById("tasa").value = tasaMatch[1];
                if (montoUsdcMatch) document.getElementById("montoUsdc").value = montoUsdcMatch[1];
                if (estatusMatch) document.getElementById("estatus").value = "Completado";

                calculateMontoBs();
            } catch (err) {
                alert("No se pudo leer el portapapeles. Aseg√∫rate de dar permisos.");
                console.error(err);
            }
        }

        // Funciones de guardado Wally
        function saveWallyOperation() {
            const operacion = document.getElementById('wallyOperacion').value;
            let operation = {
                usuario: document.getElementById('wallyUsuario').value, // A√±adido
                referencia: document.getElementById('wallyReferencia').value, // A√±adido
                operacion: operacion,
                metodo: document.getElementById('wallyMetodo').value,
                fecha: currentWallyDate,
                timestamp: Date.now()
            };

            if (operacion === 'Compra') {
                operation.reciboUsdc = parseFloat(document.getElementById('reciboUsdc').value);
                operation.tasaCompra = parseFloat(document.getElementById('tasaCompra').value);
                operation.envioUsd = parseFloat(document.getElementById('envioUsd').value);
                operation.gananciaUsdc = parseFloat(document.getElementById('gananciaUsdc').value);
            } else if (operacion === 'Venta') {
                operation.reciboUsd = parseFloat(document.getElementById('reciboUsd').value);
                operation.tasaVenta = parseFloat(document.getElementById('tasaVenta').value);
                operation.envioUsdc = parseFloat(document.getElementById('envioUsdc').value);
                operation.gananciaUsd = parseFloat(document.getElementById('gananciaUsd').value);
            }

            // Validaci√≥n
            if (!operation.usuario || !operation.referencia || !operation.operacion || !operation.metodo || 
                (operation.operacion === 'Compra' && (isNaN(operation.reciboUsdc) || isNaN(operation.tasaCompra))) ||
                (operation.operacion === 'Venta' && (isNaN(operation.reciboUsd) || isNaN(operation.tasaVenta)))) {
                alert('Por favor, complete todos los campos obligatorios y aseg√∫rese de que los valores num√©ricos sean v√°lidos.');
                return;
            }

            if (editingWallyIndex >= 0) {
                wallyOperations[editingWallyIndex] = operation;
            } else {
                wallyOperations.unshift(operation);
            }

            saveWallyOperations();
            renderWallyTables();
            updateWallySummary();
            closeWallyModal();
        }

        // Funciones de renderizado principal
        function renderTable() {
            const tbody = document.getElementById('operationsTable');
            const currentOps = operations.filter(op => op.fecha === currentDate);
            
            // Aplicar filtros y b√∫squeda
            const searchTerm = document.getElementById('searchOperations').value.toLowerCase();
            const filterOperacion = document.getElementById('filterOperacion').value;
            const filterMetodoPago = document.getElementById('filterMetodoPago').value;
            const filterEstatus = document.getElementById('filterEstatus').value;

            const filteredOps = currentOps.filter(op => {
                const matchesSearch = op.usuario.toLowerCase().includes(searchTerm) || 
                                      op.referencia.toLowerCase().includes(searchTerm);
                const matchesOperacion = filterOperacion === '' || op.operacion === filterOperacion;
                const matchesMetodoPago = filterMetodoPago === '' || op.metodoPago === filterMetodoPago;
                const matchesEstatus = filterEstatus === '' || op.estatus === filterEstatus;

                return matchesSearch && matchesOperacion && matchesMetodoPago && matchesEstatus;
            });

            tbody.innerHTML = filteredOps.map((op, index) => {
                const globalIndex = operations.indexOf(op);
                return `
                    <tr class="${op.operacion.toLowerCase()}">
                        <td>${op.usuario}</td>
                        <td>${op.referencia}</td>
                        <td>${op.operacion}</td>
                        <td>${op.tasa.toFixed(2)}</td>
                        <td>${op.metodoPago}</td>
                        <td>${op.montoUsdc.toFixed(2)}</td>
                        <td>${op.montoBs.toFixed(2)}</td>
                        <td>${op.comisionVes.toFixed(2)}</td>
                        <td>${op.total.toFixed(2)}</td>
                        <td>${(op.ves || 0).toFixed(2)}</td>
                        <td>${(op.usdc || 0).toFixed(6)}</td>
                        <td>
                            <div class="lote-scroll">${op.lote || ''}</div>
                        </td>
                        <td><span class="status-${op.estatus.toLowerCase().replace(' ', '-')}">${op.estatus}</span></td>
                        <td>
                            <button class="edit-btn" onclick="editOperation(${globalIndex})">Editar</button>
                            <button class="delete-btn" onclick="deleteOperation(${globalIndex})">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Funci√≥n para aplicar filtros y b√∫squeda
        function filterOperations() {
            renderTable();
        }

        // Funciones de renderizado Wally
        function renderWallyTables() {
            const currentOps = wallyOperations.filter(op => op.fecha === currentWallyDate);
            const compras = currentOps.filter(op => op.operacion === 'Compra');
            const ventas = currentOps.filter(op => op.operacion === 'Venta');
            
            // Tabla de compras
            document.getElementById('wallyCompraTable').innerHTML = compras.map((op) => {
                const globalIndex = wallyOperations.indexOf(op);
                return `
                    <tr>
                        <td>${op.usuario || ''}</td>
                        <td>${op.referencia || ''}</td>
                        <td>${(Number(op.reciboUsdc) || 0).toFixed(2)}</td>
                        <td>${(Number(op.tasaCompra) || 0).toFixed(3)}</td>
                        <td>${(Number(op.envioUsd) || 0).toFixed(2)}</td>
                        <td>${(Number(op.gananciaUsdc) || 0).toFixed(4)}</td>
                        <td>
                            <button class="edit-btn" onclick="editWallyOperation(${globalIndex})">Editar</button>
                            <button class="delete-btn" onclick="deleteWallyOperation(${globalIndex})">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Tabla de ventas
            document.getElementById('wallyVentaTable').innerHTML = ventas.map((op) => {
                const globalIndex = wallyOperations.indexOf(op);
                return `
                    <tr>
                        <td>${op.usuario || ''}</td>
                        <td>${op.referencia || ''}</td>
                        <td>${(Number(op.reciboUsd) || 0).toFixed(2)}</td>
                        <td>${(Number(op.tasaVenta) || 0).toFixed(3)}</td>
                        <td>${(Number(op.envioUsdc) || 0).toFixed(2)}</td>
                        <td>${(Number(op.gananciaUsd) || 0).toFixed(4)}</td>
                        <td>
                            <button class="edit-btn" onclick="editWallyOperation(${globalIndex})">Editar</button>
                            <button class="delete-btn" onclick="deleteWallyOperation(${globalIndex})">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Funci√≥n para editar una operaci√≥n Wally
        function editWallyOperation(index) {
            if (typeof index !== 'number' || index < 0 || index >= wallyOperations.length) return;
            editingWallyIndex = index;
            const op = wallyOperations[index];

            document.getElementById('wallyModalTitle').textContent = 'Editar Operaci√≥n Wally Tech';
            document.getElementById('wallyUsuario').value = op.usuario || ''; // A√±adido
            document.getElementById('wallyReferencia').value = op.referencia || ''; // A√±adido
            document.getElementById('wallyOperacion').value = op.operacion || '';
            document.getElementById('wallyMetodo').value = op.metodo || '';
            updateWallyFields();

            if (op.operacion === 'Compra') {
                document.getElementById('reciboUsdc').value = op.reciboUsdc != null ? op.reciboUsdc : '';
                document.getElementById('tasaCompra').value = op.tasaCompra != null ? op.tasaCompra : '';
                document.getElementById('envioUsd').value = op.envioUsd != null ? Number(op.envioUsd).toFixed(2) : '';
                document.getElementById('gananciaUsdc').value = op.gananciaUsdc != null ? Number(op.gananciaUsdc).toFixed(4) : '';
            } else if (op.operacion === 'Venta') {
                document.getElementById('reciboUsd').value = op.reciboUsd != null ? op.reciboUsd : '';
                document.getElementById('tasaVenta').value = op.tasaVenta != null ? op.tasaVenta : '';
                document.getElementById('envioUsdc').value = op.envioUsdc != null ? Number(op.envioUsdc).toFixed(2) : '';
                document.getElementById('gananciaUsd').value = op.gananciaUsd != null ? Number(op.gananciaUsd).toFixed(4) : '';
            }

            document.getElementById('wallyModal').style.display = 'block';
        }

        // Funci√≥n para eliminar una operaci√≥n Wally
        function deleteWallyOperation(index) {
            if (typeof index !== 'number' || index < 0 || index >= wallyOperations.length) return;
            if (!confirm('¬øEst√° seguro de eliminar esta operaci√≥n Wally?')) return;

            wallyOperations.splice(index, 1);
            saveWallyOperations();
            renderWallyTables();
            updateWallySummary();
            updateWallyHistorySelector();
        }

        // Helper: Aplica FIFO sobre las operaciones
        function applyFIFOForDate(fecha) {
            const ops = operations
                .map((op, idx) => ({ op, idx }))
                .filter(x => x.op.fecha === fecha)
                .sort((a, b) => (a.op.timestamp || 0) - (b.op.timestamp || 0));

            ops.forEach(item => {
                const o = item.op;
                o._gainVes = 0;
                o._gainUsdc = 0;
                o._assignedLots = [];
                o._remainingUsdc = (o.operacion === 'Compra') ? (Number(o.montoUsdc) || 0) : 0;
            });

            let purchaseQueue = ops
                .filter(item => item.op.operacion === 'Compra' && (Number(item.op.montoUsdc) || 0) > 0)
                .map(item => ({
                    op: item.op,
                    idx: item.idx,
                    remaining: Number(item.op.montoUsdc) || 0,
                    tasa: Number(item.op.tasa) || 0
                }));

            const sales = ops
                .filter(item => item.op.operacion === 'Venta' && (Number(item.op.montoUsdc) || 0) > 0)
                .map(item => ({
                    op: item.op,
                    idx: item.idx,
                    montoUsdc: Number(item.op.montoUsdc) || 0,
                    tasa: Number(item.op.tasa) || 0,
                    comisionVes: Number(item.op.comisionVes) || 0,
                    timestamp: item.op.timestamp || 0
                }))
                .sort((a, b) => a.timestamp - b.timestamp);

            let lotCounter = 1;

            sales.forEach(sale => {
                let remainingToMatch = sale.montoUsdc;
                const lotId = `L${lotCounter++}`;
                sale.op._assignedLots = sale.op._assignedLots || [];
                sale.op._gainVes = sale.op._gainVes || 0;
                sale.op._gainUsdc = sale.op._gainUsdc || 0;
                sale.op.lote = lotId; // Asigna el lote a la operaci√≥n de venta

                while (remainingToMatch > 0 && purchaseQueue.length > 0) {
                    const head = purchaseQueue[0];
                    const consume = Math.min(remainingToMatch, head.remaining);

                    const costVes = consume * (head.tasa || 0);
                    const revenueVes = consume * (sale.tasa || 0);
                    const commissionPortion = sale.comisionVes * (consume / (sale.montoUsdc || 1));

                    const gainVes = revenueVes - costVes - commissionPortion;
                    const divisor = head.tasa || sale.tasa || 1; // Usar la tasa de compra para calcular ganancia en USDC
                    const gainUsdc = gainVes / divisor;

                    sale.op._gainVes += gainVes;
                    sale.op._gainUsdc += gainUsdc;

                    // Actualizar la operaci√≥n de compra con la ganancia y el lote asignado
                    head.op._gainVes = (head.op._gainVes || 0) + gainVes;
                    head.op._gainUsdc = (head.op._gainUsdc || 0) + gainUsdc;
                    head.op._assignedLots = head.op._assignedLots || [];
                    head.op._assignedLots.push({ lot: lotId, amount: consume });

                    head.remaining -= consume;
                    head.op._remainingUsdc = head.remaining;
                    remainingToMatch -= consume;

                    if (head.remaining <= 0) {
                        purchaseQueue.shift();
                    }
                }

                // Si a√∫n queda monto por emparejar en la venta (ej. si no hay compras suficientes)
                if (remainingToMatch > 0) {
                    const revenueVes = remainingToMatch * (sale.tasa || 0);
                    const commissionPortion = sale.comisionVes * (remainingToMatch / (sale.montoUsdc || 1));
                    const gainVes = revenueVes - commissionPortion;
                    const gainUsdc = gainVes / (sale.tasa || 1); // Usar la tasa de venta para calcular ganancia en USDC
                    
                    sale.op._gainVes += gainVes;
                    sale.op._gainUsdc += gainUsdc;
                    remainingToMatch = 0;
                }
            });

            ops.forEach(item => {
                const o = item.op;
                o.ves = Number((o._gainVes || 0).toFixed(2));
                o.usdc = Number((o._gainUsdc || 0).toFixed(6));

                if (o.operacion === 'Compra') {
                    if (o._assignedLots && o._assignedLots.length > 0) {
                        // Formato: L1(10.00),L2(5.00)
                        o.lote = o._assignedLots.map(a => `${a.lot}(${Number(a.amount).toFixed(2)})`).join(',');
                    } else {
                        o.lote = ''; // Si no se asign√≥ a ning√∫n lote, el campo lote queda vac√≠o
                    }
                }

                // Limpiar propiedades temporales
                delete o._assignedLots;
                delete o._remainingUsdc;
                delete o._gainVes;
                delete o._gainUsdc;
            });

            // Notificar al IA que las operaciones han sido recalculadas
            if (window.aiCenter) {
                window.notifyAIRecalculation();
            }
            saveOperations(); // Guardar las operaciones actualizadas con los lotes y ganancias
        }

        // Actualizar resumen
        function updateSummary() {
            const currentOps = operations.filter(op => op.fecha === currentDate);
            const compras = currentOps.filter(op => op.operacion === 'Compra');
            const ventas = currentOps.filter(op => op.operacion === 'Venta');
            
            const promCompra = compras.length > 0 ? 
                compras.reduce((sum, op) => sum + (Number(op.tasa) || 0), 0) / compras.length : 0;
            const promVenta = ventas.length > 0 ? 
                ventas.reduce((sum, op) => sum + (Number(op.tasa) || 0), 0) / ventas.length : 0;
            
            const brecha = promVenta > 0 && promCompra > 0 ? 
                ((promVenta - promCompra) / promCompra * 100) : 0;
            
            document.getElementById('promCompra').textContent = promCompra.toFixed(2);
            document.getElementById('promVenta').textContent = promVenta.toFixed(2);
            document.getElementById('brecha').textContent = brecha.toFixed(2) + '%';
            
            applyFIFOForDate(currentDate); // Asegura que los campos ves/usdc y lote est√©n actualizados

            const gananciasVesSoloCompras = currentOps
                .filter(op => op.operacion === 'Compra')
                .reduce((sum, op) => sum + (Number(op.ves) || 0), 0);

            const gananciasUsdcSoloCompras = currentOps
                .filter(op => op.operacion === 'Compra')
                .reduce((sum, op) => sum + (Number(op.usdc) || 0), 0);

            document.getElementById('ganancias').innerHTML = `
                <div>${gananciasVesSoloCompras.toFixed(2)} VES</div>
                <div>${gananciasUsdcSoloCompras.toFixed(2)} USDC</div>
            `;

            document.getElementById('totalOps').textContent = currentOps.length;
            renderTable();
        }

        function updateWallySummary() {
            const currentOps = wallyOperations.filter(op => op.fecha === currentWallyDate);
            const compras = currentOps.filter(op => op.operacion === 'Compra');
            const ventas = currentOps.filter(op => op.operacion === 'Venta');

            const totalEnvioUsd_fromCompras = compras.reduce((s, op) => s + (Number(op.envioUsd) || 0), 0);
            const totalReciboUsdc_fromCompras = compras.reduce((s, op) => s + (Number(op.reciboUsdc) || 0), 0);

            const totalEnvioUsdc_fromVentas = ventas.reduce((s, op) => s + (Number(op.envioUsdc) || 0), 0);
            const totalReciboUsd_fromVentas = ventas.reduce((s, op) => s + (Number(op.reciboUsd) || 0), 0);

            // El valor actual de Wally es el valor inicial + (recibos - env√≠os)
            const iniValue = parseFloat(localStorage.getItem(`wallyValorInicial_${currentWallyDate}`)) || 0;
            const valAct = iniValue + totalReciboUsdc_fromCompras + totalReciboUsd_fromVentas - totalEnvioUsd_fromCompras - totalEnvioUsdc_fromVentas;

            document.getElementById("wallyValorActual").textContent = `${valAct.toFixed(2)}`;
            
            // Guardar el valor actual para el d√≠a actual, para que sea el inicial del siguiente d√≠a
            localStorage.setItem(`wallyValorActual_${currentWallyDate}`, valAct.toFixed(2));

            const totalGananciaUsdc = compras.reduce((s, op) => s + (Number(op.gananciaUsdc) || 0), 0);
            const totalGananciaUsd = ventas.reduce((s, op) => s + (Number(op.gananciaUsd) || 0), 0);

            document.getElementById("wallyGanancias").textContent =
                `${totalGananciaUsdc.toFixed(2)} USDC / ${totalGananciaUsd.toFixed(2)} USD`;
        }

        function editOperation(index) {
            editingIndex = index;
            const op = operations[index];
            
            document.getElementById('modalTitle').textContent = 'Editar Operaci√≥n';
            document.getElementById('usuario').value = op.usuario;
            document.getElementById('referencia').value = op.referencia;
            document.getElementById('operacion').value = op.operacion;
            document.getElementById('tasa').value = op.tasa;
            document.getElementById('metodoPago').value = op.metodoPago;
            document.getElementById('montoUsdc').value = op.montoUsdc;
            document.getElementById('montoBs').value = op.montoBs;
            document.getElementById('comisionVes').value = op.comisionVes;
            document.getElementById('total').value = op.total;
            document.getElementById('ves').value = op.ves;
            document.getElementById('usdc').value = op.usdc;
            document.getElementById('lote').value = op.lote;
            document.getElementById('estatus').value = op.estatus;
            
            updateFeeField();
            document.getElementById('operationModal').style.display = 'block';
        }

        function deleteOperation(index) {
            if (confirm('¬øEst√° seguro de eliminar esta operaci√≥n?')) {
                operations.splice(index, 1);
                saveOperations();
                renderTable();
                updateSummary();
            }
        }

        // Funciones de almacenamiento
        function saveOperations() {
            localStorage.setItem('operations', JSON.stringify(operations));
        }

        function loadOperations() {
            currentDate = document.getElementById('selectedDate').value;
            operations = JSON.parse(localStorage.getItem('operations') || '[]');
            renderTable();
            updateSummary();
        }

        function saveWallyOperations() {
            localStorage.setItem('wallyOperations', JSON.stringify(wallyOperations));
        }

        function loadWallyOperations() {
            const prevWallyDate = currentWallyDate; // Guarda la fecha anterior
            currentWallyDate = document.getElementById('wallySelectedDate').value;
            wallyOperations = JSON.parse(localStorage.getItem('wallyOperations') || '[]');
            
            // L√≥gica para el saldo inicial diario
            const wallyValorInicialInput = document.getElementById('wallyValorInicialInput');
            const savedInitialForToday = localStorage.getItem(`wallyValorInicial_${currentWallyDate}`);
            
            if (savedInitialForToday) {
                wallyValorInicialInput.value = savedInitialForToday;
                wallyValorInicialInput.readOnly = true;
                document.getElementById('editWallyIniBtn').style.display = 'inline';
            } else {
                // Si no hay un valor inicial guardado para hoy, intenta cargar el valor actual del d√≠a anterior
                const prevDayActualValue = localStorage.getItem(`wallyValorActual_${getPreviousDate(currentWallyDate)}`);
                if (prevDayActualValue) {
                    wallyValorInicialInput.value = prevDayActualValue;
                    localStorage.setItem(`wallyValorInicial_${currentWallyDate}`, prevDayActualValue); // Guarda como inicial para hoy
                    wallyValorInicialInput.readOnly = true;
                    document.getElementById('editWallyIniBtn').style.display = 'inline';
                } else {
                    wallyValorInicialInput.value = '0.00'; // Si no hay nada, por defecto 0
                    wallyValorInicialInput.readOnly = false;
                    document.getElementById('editWallyIniBtn').style.display = 'none';
                }
            }

            renderWallyTables();
            updateWallySummary();
        }

        // Helper para obtener la fecha anterior
        function getPreviousDate(dateString) {
            const date = new Date(dateString);
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }

        function updateHistorySelector() {
            const dates = [...new Set(operations.map(op => op.fecha))].sort().reverse();
            const selector = document.getElementById('historySelector');
            
            selector.innerHTML = '<option value="">Ver historial por fecha</option>' +
                dates.map(date => `<option value="${date}">${date}</option>`).join('');
        }

        function updateWallyHistorySelector() {
            const dates = [...new Set(wallyOperations.map(op => op.fecha))].sort().reverse();
            const selector = document.getElementById('wallyHistorySelector');
            
            selector.innerHTML = '<option value="">Ver historial por fecha</option>' +
                dates.map(date => `<option value="${date}">${date}</option>`).join('');
        }

        function loadHistoryDate() {
            const selectedDate = document.getElementById('historySelector').value;
            if (selectedDate) {
                document.getElementById('selectedDate').value = selectedDate;
                currentDate = selectedDate;
                loadOperations();
            }
        }

        function loadWallyHistoryDate() {
            const selectedDate = document.getElementById('wallyHistorySelector').value;
            if (selectedDate) {
                document.getElementById('wallySelectedDate').value = selectedDate;
                currentWallyDate = selectedDate;
                loadWallyOperations();
            }
        }

        // Event listeners para cambio de fecha
        document.getElementById('selectedDate').addEventListener('change', function() {
            loadOperations();
            updateHistorySelector();
        });

        document.getElementById('wallySelectedDate').addEventListener('change', function() {
            loadWallyOperations();
            updateWallyHistorySelector();
        });

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const operationModal = document.getElementById('operationModal');
            const wallyModal = document.getElementById('wallyModal');
            const aiPanel = document.getElementById('aiPanel');
            
            if (event.target === operationModal) {
                closeModal();
            }
            if (event.target === wallyModal) {
                closeWallyModal();
            }
            if (!document.getElementById('aiOperationsCenter').contains(event.target) && 
                aiPanel.style.display === 'flex') {
                document.getElementById('aiPanel').style.display = 'none';
                window.aiCenter.isOpen = false;
            }
        }

        function toggleInfo() {
            const extra = document.getElementById("infoExtra");
            const icon = document.getElementById("infoIcon");
            const isHidden = extra.style.display === "none" || extra.style.display === "";
            extra.style.display = isHidden ? "block" : "none";
            icon.textContent = isHidden ? "‚ñ≤" : "‚ñº";
        }

        function saveWallyValorInicial() {
            const input = document.getElementById("wallyValorInicialInput");
            const editBtn = document.getElementById("editWallyIniBtn");
            const value = parseFloat(input.value) || 0;

            if (value >= 0) { // Permitir 0 como valor inicial
                localStorage.setItem(`wallyValorInicial_${currentWallyDate}`, value.toFixed(2));
                input.value = value.toFixed(2);
                input.readOnly = true;
                editBtn.style.display = "inline";
                updateWallySummary();
            }
        }

        function editWallyValorInicial() {
            const input = document.getElementById("wallyValorInicialInput");
            const editBtn = document.getElementById("editWallyIniBtn");
            input.readOnly = false;
            input.focus();
            editBtn.style.display = "none";
        }

        function loadWallyValorInicial() {
            const input = document.getElementById("wallyValorInicialInput");
            const editBtn = document.getElementById("editWallyIniBtn");
            const saved = localStorage.getItem(`wallyValorInicial_${currentWallyDate}`);
            if (saved) {
                input.value = saved;
                input.readOnly = true;
                editBtn.style.display = "inline";
            } else {
                // Si no hay un valor inicial guardado para hoy, intenta cargar el valor actual del d√≠a anterior
                const prevDayActualValue = localStorage.getItem(`wallyValorActual_${getWallyPreviousDate(currentWallyDate)}`);
                if (prevDayActualValue) {
                    input.value = prevDayActualValue;
                    localStorage.setItem(`wallyValorInicial_${currentWallyDate}`, prevDayActualValue); // Guarda como inicial para hoy
                    input.readOnly = true;
                    editBtn.style.display = "inline";
                } else {
                    input.value = '0.00'; // Si no hay nada, por defecto 0
                    input.readOnly = false;
                    editBtn.style.display = "none";
                }
            }
        }

        // Helper para obtener la fecha anterior para Wally
        function getWallyPreviousDate(dateString) {
            const date = new Date(dateString);
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }

        // ===== SISTEMA DE INTELIGENCIA ARTIFICIAL =====
        class AIOperationsCenter {
            constructor() {
                this.notifications = []; // All notifications
                this.alerts = []; // Critical alerts
                this.isOpen = false;
                this.processedOperations = new Set();
                this.lastOperationCount = 0;
                this.lastLotStates = new Map();
                this.lastMetrics = {
                    brecha: 0,
                    ganancias: { ves: 0, usdc: 0 },
                    operationsCount: 0
                };
                this.alertThresholds = {
                    brechaMin: 2,
                    brechaMax: 4,
                    muchoLotes: 3,
                    recompraCritica: 100, // Umbral para recompra cr√≠tica
                    reventaCritica: 100 // Umbral para reventa cr√≠tica
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadNotifications();
                this.startMonitoring();
            }

            setupEventListeners() {
                document.getElementById('aiToggleBtn').onclick = () => this.toggle();
            }

            toggle() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }

            open() {
                document.getElementById('aiPanel').style.display = 'flex';
                this.isOpen = true;
                this.clearNotificationBadge();
                this.updateMetrics();
                this.renderNotifications(); // Re-render to ensure correct display
            }

            close() {
                document.getElementById('aiPanel').style.display = 'none';
                this.isOpen = false;
            }

            analyzeCurrentState() {
                if (typeof operations !== 'undefined' && typeof currentDate !== 'undefined') {
                    const todayOps = operations.filter(op => op.fecha === currentDate);
                    
                    // Procesar nuevas operaciones
                    if (todayOps.length > this.lastOperationCount) {
                        const newOperations = todayOps.slice(this.lastOperationCount);
                        newOperations.forEach(op => {
                            this.processNewOperation(op);
                        });
                    }
                    
                    this.analyzeLotChangesWithFIFO(todayOps);
                    this.analyzeBreach(todayOps);
                    this.analyzeGainsSynchronized(todayOps);
                    this.analyzePendingBalances(todayOps);
                    this.lastOperationCount = todayOps.length;
                    this.updateMetrics();
                } else {
                    // Si no hay operaciones o currentDate no est√° definido, resetear m√©tricas
                    this.updateMetrics(); 
                }
            }

            processNewOperation(operation) {
                const operationKey = `${operation.fecha}-${operation.usuario}-${operation.operacion}-${operation.montoUsdc}-${operation.tasa}-${operation.timestamp}`;
                if (this.processedOperations.has(operationKey)) return;
                this.processedOperations.add(operationKey);

                const gananciaUsdc = parseFloat(operation.usdc) || 0;
                const gananciaVes = parseFloat(operation.ves) || 0;
                
                this.addNotification('success', 
                    `${operation.operacion} Registrada`, 
                    `${operation.usuario}: ${operation.operacion} de ${operation.montoUsdc} USDC a ${operation.tasa}`, {
                    usuario: operation.usuario,
                    monto: `${operation.montoUsdc} USDC`,
                    tasa: operation.tasa,
                    gananciaUsdc: `${gananciaUsdc.toFixed(4)} USDC`,
                    gananciaVes: `${gananciaVes.toFixed(2)} VES`
                });
            }

            analyzeLotChangesWithFIFO(operations) {
                const currentLots = this.extractLotsFromFIFOSystem(operations);
                const previousLots = this.lastLotStates;
                
                previousLots.forEach((prevLot, lotId) => {
                    const currentLot = currentLots.get(lotId);
                    if (prevLot.estado === 'activo' && (!currentLot || currentLot.estado === 'cerrado')) {
                        const lotKey = `closed_${lotId}`;
                        if (!this.processedOperations.has(lotKey)) {
                            this.processedOperations.add(lotKey);
                            const ganancia = this.calculateLotTotalGain(lotId, operations);
                            this.addNotification('success', 
                                '‚úÖ Lote Completado', 
                                `Lote ${lotId} cerrado completamente`, {
                                loteId: lotId,
                                gananciaTotal: `${ganancia.ves.toFixed(2)} VES / ${ganancia.usdc.toFixed(4)} USDC`,
                                estado: 'Cerrado'
                            });
                        }
                    }
                });

                currentLots.forEach((currentLot, lotId) => {
                    if (!previousLots.has(lotId)) {
                        const lotKey = `new_${lotId}`;
                        if (!this.processedOperations.has(lotKey)) {
                            this.processedOperations.add(lotKey);
                            this.addNotification('info', 
                                'üì¶ Nuevo Lote Creado', 
                                `Lote ${lotId} iniciado`, {
                                loteId: lotId,
                                estado: 'Activo'
                            });
                        }
                    }
                });

                currentLots.forEach((currentLot, lotId) => {
                    const prevLot = previousLots.get(lotId);
                    if (prevLot && prevLot.progreso !== currentLot.progreso && currentLot.estado === 'activo') {
                        const progressKey = `progress_${lotId}_${currentLot.progreso}`;
                        if (!this.processedOperations.has(progressKey)) {
                            this.processedOperations.add(progressKey);
                            this.addNotification('info', 
                                'üìä Progreso de Lote', 
                                `Lote ${lotId}: ${currentLot.progreso.toFixed(1)}% completado`, {
                                loteId: lotId,
                                progreso: `${currentLot.progreso.toFixed(1)}%`,
                                restante: `${(100 - currentLot.progreso).toFixed(1)}%`
                            });
                        }
                    }
                });

                const lotesActivos = Array.from(currentLots.values()).filter(lote => lote.estado === 'activo').length;
                const prevLotesActivos = Array.from(previousLots.values()).filter(lote => lote.estado === 'activo').length;
                if (lotesActivos >= this.alertThresholds.muchoLotes && prevLotesActivos < this.alertThresholds.muchoLotes) {
                    this.addNotification('warning', 
                        '‚ö†Ô∏è Muchos Lotes Activos', 
                        `Tienes ${lotesActivos} lotes en progreso`, {
                        lotesActivos: lotesActivos,
                        recomendacion: 'Considerar enfocar en completar ventas'
                    });
                }

                this.lastLotStates = new Map(currentLots);
            }

            extractLotsFromFIFOSystem(operations) {
                const lotMap = new Map();
                
                // Primero, identificar todas las ventas y sus lotes
                operations.filter(op => op.operacion === 'Venta' && op.lote && op.lote.trim()).forEach(venta => {
                    const lotId = venta.lote.trim();
                    if (!lotMap.has(lotId)) {
                        lotMap.set(lotId, {
                            id: lotId,
                            montoTotal: 0, // Suma de USDC de compras asignadas a este lote
                            montoVendido: 0, // Suma de USDC de ventas asignadas a este lote
                            estado: 'activo',
                            progreso: 0,
                            comprasAsociadas: [],
                            ventasAsociadas: []
                        });
                    }
                    const lot = lotMap.get(lotId);
                    lot.montoVendido += parseFloat(venta.montoUsdc) || 0;
                    lot.ventasAsociadas.push(venta);
                });

                // Luego, asignar las compras a los lotes existentes
                operations.filter(op => op.operacion === 'Compra' && op.lote && op.lote.trim()).forEach(compra => {
                    const loteTexto = compra.lote;
                    const loteMatches = loteTexto.match(/([L]\d+)\(([^)]+)\)/g);
                    if (loteMatches) {
                        loteMatches.forEach(match => {
                            const [, lotId, amount] = match.match(/([L]\d+)\(([^)]+)\)/);
                            if (lotMap.has(lotId)) {
                                const lot = lotMap.get(lotId);
                                lot.montoTotal += parseFloat(amount) || 0;
                                lot.comprasAsociadas.push({
                                    operacion: compra,
                                    monto: parseFloat(amount) || 0
                                });
                            }
                        });
                    }
                });

                // Calcular progreso y estado final
                lotMap.forEach((lot) => {
                    if (lot.montoTotal > 0) {
                        lot.progreso = Math.min((lot.montoVendido / lot.montoTotal) * 100, 100);
                        lot.estado = lot.progreso >= 99.9 ? 'cerrado' : 'activo';
                    } else if (lot.montoVendido > 0) {
                        // Caso donde hay ventas pero no compras asignadas (lote "abierto" sin origen claro)
                        lot.estado = 'activo';
                        lot.progreso = 0; // O alg√∫n otro valor que indique que no hay compras para medir progreso
                    } else {
                        lot.estado = 'inactivo'; // Lote sin compras ni ventas
                        lot.progreso = 0;
                    }
                });

                return lotMap;
            }

            calculateLotTotalGain(lotId, operations) {
                // Sumar las ganancias de las operaciones de compra que tienen este lote asignado
                const comprasDelLote = operations.filter(op => 
                    op.operacion === 'Compra' && 
                    op.lote && 
                    op.lote.includes(lotId)
                );

                const gananciaVes = comprasDelLote.reduce((sum, op) => sum + (parseFloat(op.ves) || 0), 0);
                const gananciaUsdc = comprasDelLote.reduce((sum, op) => sum + (parseFloat(op.usdc) || 0), 0);

                return { ves: gananciaVes, usdc: gananciaUsdc };
            }

            analyzeBreach(operations) {
                const compras = operations.filter(op => op.operacion === 'Compra');
                const ventas = operations.filter(op => op.operacion === 'Venta');
                if (compras.length === 0 || ventas.length === 0) return;

                const promCompra = compras.reduce((sum, op) => sum + parseFloat(op.tasa), 0) / compras.length;
                const promVenta = ventas.reduce((sum, op) => sum + parseFloat(op.tasa), 0) / ventas.length;
                const brecha = ((promVenta - promCompra) / promCompra * 100);

                const cambioBrecha = Math.abs(brecha - this.lastMetrics.brecha);
                if (cambioBrecha > 1) { // Solo notificar si hay un cambio significativo
                    if (brecha < this.alertThresholds.brechaMin) {
                        this.addAlert('warning', 'Brecha Baja Detectada', 
                            `La brecha baj√≥ a ${brecha.toFixed(2)}%. Considera ajustar tasas.`, {
                            brecha: `${brecha.toFixed(2)}%`,
                            promCompra: promCompra.toFixed(2),
                            promVenta: promVenta.toFixed(2)
                        });
                    } else if (brecha > this.alertThresholds.brechaMax) {
                        this.addAlert('success', 'Oportunidad: Brecha Alta', 
                            `Excelente brecha de ${brecha.toFixed(2)}%. ¬°Buen momento para operar!`, {
                            brecha: `${brecha.toFixed(2)}%`,
                            promCompra: promCompra.toFixed(2),
                            promVenta: promVenta.toFixed(2)
                        });
                    }
                }

                this.lastMetrics.brecha = brecha;
            }

            analyzeGainsSynchronized(operations) {
                const compras = operations.filter(op => op.operacion === 'Compra');
                const gananciasVes = compras.reduce((sum, op) => sum + (parseFloat(op.ves) || 0), 0);
                const gananciasUsdc = compras.reduce((sum, op) => sum + (parseFloat(op.usdc) || 0), 0);

                const cambioVes = Math.abs(gananciasVes - this.lastMetrics.ganancias.ves);
                const cambioUsdc = Math.abs(gananciasUsdc - this.lastMetrics.ganancias.usdc);

                if (cambioVes > 5 || cambioUsdc > 0.01) { // Notificar si hay un cambio significativo en las ganancias
                    this.addNotification('info', 
                        'üí∞ Ganancias Actualizadas', 
                        `Ganancias del d√≠a actualizadas`, {
                        gananciaVes: `${gananciasVes.toFixed(2)} VES`,
                        gananciaUsdc: `${gananciasUsdc.toFixed(4)} USDC`,
                        cambio: `+${cambioVes.toFixed(2)} VES / +${cambioUsdc.toFixed(4)} USDC`
                    });
                }

                this.lastMetrics.ganancias = { ves: gananciasVes, usdc: gananciasUsdc };
            }

            analyzePendingBalances(operations) {
                const compras = operations.filter(op => op.operacion === 'Compra');
                const ventas = operations.filter(op => op.operacion === 'Venta');

                const totalComprado = compras.reduce((sum, op) => sum + parseFloat(op.montoUsdc || 0), 0);
                const totalVendido = ventas.reduce((sum, op) => sum + parseFloat(op.montoUsdc || 0), 0);

                const recompraPendiente = Math.max(0, totalVendido - totalComprado);
                const reventaPendiente = Math.max(0, totalComprado - totalVendido);

                // Notificaci√≥n para recompra pendiente
                if (recompraPendiente > this.alertThresholds.recompraCritica && 
                    !this.processedOperations.has(`recompra_critica_${currentDate}`)) {
                    this.addAlert('danger', 'üö® Recompra Cr√≠tica', 
                        `Necesitas recomprar ${recompraPendiente.toFixed(2)} USDC para equilibrar tus ventas.`, {
                        monto: `${recompraPendiente.toFixed(2)} USDC`,
                        tipo: 'Recompra'
                    });
                    this.processedOperations.add(`recompra_critica_${currentDate}`);
                } else if (recompraPendiente === 0 && this.processedOperations.has(`recompra_critica_${currentDate}`)) {
                    this.addAlert('success', '‚úÖ Recompra Equilibrada', 
                        'Ya no hay recompra pendiente. Tus operaciones est√°n equilibradas.', {
                        monto: '0 USDC',
                        tipo: 'Recompra'
                    });
                    this.processedOperations.delete(`recompra_critica_${currentDate}`);
                }

                // Notificaci√≥n para reventa pendiente
                if (reventaPendiente > this.alertThresholds.reventaCritica && 
                    !this.processedOperations.has(`reventa_critica_${currentDate}`)) {
                    this.addAlert('warning', '‚ö†Ô∏è Reventa Pendiente', 
                        `Tienes ${reventaPendiente.toFixed(2)} USDC comprados sin vender. Considera revender.`, {
                        monto: `${reventaPendiente.toFixed(2)} USDC`,
                        tipo: 'Reventa'
                    });
                    this.processedOperations.add(`reventa_critica_${currentDate}`);
                } else if (reventaPendiente === 0 && this.processedOperations.has(`reventa_critica_${currentDate}`)) {
                    this.addAlert('success', '‚úÖ Reventa Equilibrada', 
                        'Ya no hay reventa pendiente. Tus operaciones est√°n equilibradas.', {
                        monto: '0 USDC',
                        tipo: 'Reventa'
                    });
                    this.processedOperations.delete(`reventa_critica_${currentDate}`);
                }
            }

            addNotification(type, title, content, metrics = null) {
                const notificationKey = `${title}-${content}`;
                const existingToday = this.notifications.find(n => 
                    n.date === new Date().toISOString().split('T')[0] && 
                    `${n.title}-${n.content}` === notificationKey
                );

                // Evitar duplicados en un corto periodo de tiempo (30 segundos)
                if (existingToday && Date.now() - new Date(existingToday.time).getTime() < 30000) {
                    return;
                }

                const notification = {
                    id: Date.now(),
                    type: type,
                    title: title,
                    content: content,
                    metrics: metrics,
                    time: new Date(),
                    date: new Date().toISOString().split('T')[0]
                };

                this.notifications.unshift(notification);
                const today = notification.date;
                const todayNotifications = this.notifications.filter(n => n.date === today);
                
                // Limitar el n√∫mero de notificaciones por d√≠a para evitar sobrecarga visual
                if (todayNotifications.length > 20) { // Aumentado el l√≠mite a 20
                    this.notifications = this.notifications.filter(n => 
                        n.date !== today || todayNotifications.slice(0, 20).includes(n)
                    );
                }

                this.renderNotifications();
                this.saveNotifications();
                this.updateBadge();
                this.updateSystemStatus(type);
            }

            addAlert(type, title, content, metrics = null) {
                const alertKey = `${title}-${content}`;
                const existingToday = this.alerts.find(a => 
                    a.date === new Date().toISOString().split('T')[0] && 
                    `${a.title}-${a.content}` === alertKey
                );

                // Evitar duplicados en un corto periodo de tiempo (30 segundos)
                if (existingToday && Date.now() - new Date(existingToday.time).getTime() < 30000) {
                    return;
                }

                const alert = {
                    id: Date.now(),
                    type: type,
                    title: title,
                    content: content,
                    metrics: metrics,
                    time: new Date(),
                    date: new Date().toISOString().split('T')[0]
                };

                this.alerts.unshift(alert);
                const today = alert.date;
                const todayAlerts = this.alerts.filter(a => a.date === today);
                
                // Limitar el n√∫mero de alertas por d√≠a
                if (todayAlerts.length > 10) { 
                    this.alerts = this.alerts.filter(a => 
                        a.date !== today || todayAlerts.slice(0, 10).includes(a)
                    );
                }

                this.renderNotifications();
                this.saveNotifications();
                this.updateBadge();
                this.updateSystemStatus(type); // Update status based on the most critical alert
            }

            renderNotifications() {
                const container = document.getElementById('aiNotifications');
                const today = new Date().toISOString().split('T')[0];
                const todayAlerts = this.alerts.filter(n => n.date === today);
                const todayNotifications = this.notifications.filter(n => n.date === today);

                let htmlContent = '';

                const iconMap = {
                    info: 'üí°',
                    success: '‚úÖ',
                    warning: '‚ö†Ô∏è',
                    danger: 'üö®'
                };

                // Render Alerts
                if (todayAlerts.length > 0) {
                    htmlContent += `
                        <div class="notification-section">
                            <h4>${iconMap['danger']} Alertas Cr√≠ticas</h4>
                            ${todayAlerts.map(alert => `
                                <div class="notification ${alert.type}">
                                    <div class="notification-header">
                                        <div class="notification-title">
                                            <span>${iconMap[alert.type]}</span>
                                            ${alert.title}
                                        </div>
                                        <div class="notification-time">${alert.time.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                                    </div>
                                    <div class="notification-content">
                                        ${alert.content}
                                    </div>
                                    ${alert.metrics ? `
                                        <div class="notification-metrics">
                                            ${Object.entries(alert.metrics)
                                                .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                                                .join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Render General Notifications
                if (todayNotifications.length > 0) {
                    htmlContent += `
                        <div class="notification-section">
                            <h4>${iconMap['info']} Notificaciones Generales</h4>
                            ${todayNotifications.map(notification => `
                                <div class="notification ${notification.type}">
                                    <div class="notification-header">
                                        <div class="notification-title">
                                            <span>${iconMap[notification.type]}</span>
                                            ${notification.title}
                                        </div>
                                        <div class="notification-time">${notification.time.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</div>
                                    </div>
                                    <div class="notification-content">
                                        ${notification.content}
                                    </div>
                                    ${notification.metrics ? `
                                        <div class="notification-metrics">
                                            ${Object.entries(notification.metrics)
                                                .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                                                .join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                if (todayAlerts.length === 0 && todayNotifications.length === 0) {
                    htmlContent = `
                        <div class="notification info">
                            <div class="notification-header">
                                <div class="notification-title">
                                    <span>üìä</span>
                                    Sin Alertas Nuevas
                                </div>
                                <div class="notification-time">Hoy</div>
                            </div>
                            <div class="notification-content">
                                Sistema monitoreando activamente. Se te notificar√° de cambios importantes.
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = htmlContent;
            }

            updateBadge() {
                const badge = document.getElementById('aiNotificationBadge');
                const today = new Date().toISOString().split('T')[0];
                const todayCount = this.alerts.filter(n => n.date === today).length + this.notifications.filter(n => n.date === today).length;

                if (todayCount > 0 && !this.isOpen) {
                    badge.style.display = 'flex';
                    badge.textContent = Math.min(todayCount, 99);
                } else {
                    badge.style.display = 'none';
                }
            }

            updateSystemStatus(alertType) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const toggleBtn = document.getElementById('aiToggleBtn');

                toggleBtn.classList.remove('has-alerts', 'critical');
                indicator.className = 'status-indicator';

                // Determine the most critical alert type currently active
                const currentCriticality = this.alerts.some(a => a.type === 'danger') ? 'danger' :
                                           this.alerts.some(a => a.type === 'warning') ? 'warning' :
                                           'info'; // Default if no alerts

                if (currentCriticality === 'danger') {
                    indicator.classList.add('critical');
                    statusText.textContent = 'Alerta Cr√≠tica - Requiere Atenci√≥n';
                    toggleBtn.classList.add('critical');
                } else if (currentCriticality === 'warning') {
                    indicator.classList.add('warning');
                    statusText.textContent = 'Advertencia Detectada';
                    toggleBtn.classList.add('has-alerts');
                } else {
                    statusText.textContent = 'Sistema Activo - Monitoreando';
                }
            }

            updateMetrics() {
                try {
                    if (typeof operations !== 'undefined' && typeof currentDate !== 'undefined') {
                        const todayOps = operations.filter(op => op.fecha === currentDate);
                        const compras = todayOps.filter(op => op.operacion === 'Compra');
                        const ventas = todayOps.filter(op => op.operacion === 'Venta');

                        let brecha = 0;
                        if (compras.length > 0 && ventas.length > 0) {
                            const promCompra = compras.reduce((sum, op) => sum + parseFloat(op.tasa), 0) / compras.length;
                            const promVenta = ventas.reduce((sum, op) => sum + parseFloat(op.tasa), 0) / ventas.length;
                            brecha = ((promVenta - promCompra) / promCompra * 100);
                        }
                        
                        document.getElementById('currentGap').textContent = `${brecha.toFixed(2)}%`;
                        
                        const lotesActivos = Array.from(this.extractLotsFromFIFOSystem(todayOps).values())
                            .filter(lote => lote.estado === 'activo').length;
                        document.getElementById('activeLots').textContent = lotesActivos;
                        
                        const gananciasVes = compras.reduce((sum, op) => sum + (parseFloat(op.ves) || 0), 0);
                        const gananciasUsdc = compras.reduce((sum, op) => sum + (parseFloat(op.usdc) || 0), 0);
                        
                        document.getElementById('dailyProfit').innerHTML = `
                            <div>${gananciasVes.toFixed(2)} VES</div>
                            <div>${gananciasUsdc.toFixed(2)} USDC</div>
                        `;

                        const totalComprado = compras.reduce((sum, op) => sum + parseFloat(op.montoUsdc || 0), 0);
                        const totalVendido = ventas.reduce((sum, op) => sum + parseFloat(op.montoUsdc || 0), 0);
                        
                        const recompraPendiente = Math.max(0, totalVendido - totalComprado);
                        const reventaPendiente = Math.max(0, totalComprado - totalVendido);
                        
                        document.getElementById('pendingRepurchase').textContent = 
                            `${recompraPendiente.toFixed(2)} USDC`;
                        document.getElementById('pendingResale').textContent = 
                            `${reventaPendiente.toFixed(2)} USDC`;

                        const gapElement = document.getElementById('currentGap');
                        gapElement.className = 'metric-value';
                        
                        if (brecha < this.alertThresholds.brechaMin) {
                            gapElement.classList.add('negative');
                        } else if (brecha > this.alertThresholds.brechaMax) {
                            gapElement.classList.add('positive');
                        } else {
                            gapElement.classList.add('warning');
                        }

                        const repurchaseElement = document.getElementById('pendingRepurchase');
                        repurchaseElement.className = 'metric-value';
                        if (recompraPendiente > 0) {
                            repurchaseElement.classList.add('warning');
                        }

                        const resaleElement = document.getElementById('pendingResale');
                        resaleElement.className = 'metric-value';
                        if (reventaPendiente > 0) {
                            resaleElement.classList.add('warning');
                        }
                    } else {
                        // Resetear m√©tricas si no hay operaciones o currentDate no est√° definido
                        document.getElementById('currentGap').textContent = '0%';
                        document.getElementById('activeLots').textContent = '0';
                        document.getElementById('dailyProfit').innerHTML = '0 VES<br>0 USDC';
                        document.getElementById('pendingRepurchase').textContent = '0 USDC';
                        document.getElementById('pendingResale').textContent = '0 USDC';
                    }
                } catch (error) {
                    console.error("Error updating AI metrics:", error);
                    // Fallback en caso de error
                    document.getElementById('currentGap').textContent = '0%';
                    document.getElementById('activeLots').textContent = '0';
                    document.getElementById('dailyProfit').innerHTML = '0 VES<br>0 USDC';
                    document.getElementById('pendingRepurchase').textContent = '0 USDC';
                    document.getElementById('pendingResale').textContent = '0 USDC';
                }
            }

            clearNotificationBadge() {
                if (this.isOpen) {
                    document.getElementById('aiNotificationBadge').style.display = 'none';
                }
            }

            saveNotifications() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    // Guardar solo las notificaciones y alertas del d√≠a actual
                    const todayNotifications = this.notifications.filter(n => n.date === today);
                    const todayAlerts = this.alerts.filter(a => a.date === today);

                    const dataToSave = {
                        notifications: todayNotifications,
                        alerts: todayAlerts,
                        processedOperations: Array.from(this.processedOperations),
                        lastLotStates: Array.from(this.lastLotStates.entries())
                    };
                    localStorage.setItem(`aiStoredData_${today}`, JSON.stringify(dataToSave));
                } catch (error) {
                    console.error('Error saving AI data to localStorage:', error);
                }
            }

            loadNotifications() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const storedData = localStorage.getItem(`aiStoredData_${today}`);
                    if (storedData) {
                        const parsedData = JSON.parse(storedData);
                        this.notifications = (parsedData.notifications || [])
                            .map(n => ({
                                ...n,
                                time: new Date(n.time)
                            }));
                        this.alerts = (parsedData.alerts || [])
                            .map(a => ({
                                ...a,
                                time: new Date(a.time)
                            }));
                        this.processedOperations = new Set(parsedData.processedOperations || []);
                        this.lastLotStates = new Map(parsedData.lastLotStates || []);
                        this.renderNotifications();
                        this.updateBadge();
                    }
                } catch (error) {
                    console.error('Error loading AI data from localStorage:', error);
                }
            }

            startMonitoring() {
                // Ejecutar inmediatamente y luego cada 5 segundos
                this.analyzeCurrentState();
                setInterval(() => {
                    this.analyzeCurrentState();
                }, 5000);
            }

            onOperationAdded(operation) {
                // Al agregar una operaci√≥n, es posible que el `lastOperationCount` no se haya actualizado a√∫n
                // Forzamos una re-evaluaci√≥n completa para asegurar que la nueva operaci√≥n sea procesada.
                this.lastOperationCount = 0; 
                this.analyzeCurrentState();
            }

            onOperationEdited(operation) {
                // Para una operaci√≥n editada, eliminamos su clave de `processedOperations`
                // para que sea reprocesada y se genere una nueva notificaci√≥n si es necesario.
                const operationKeyPattern = `${operation.fecha}-${operation.usuario}-${operation.operacion}-${operation.montoUsdc}-${operation.tasa}`;
                // Iterar sobre las claves y eliminar las que coincidan con el patr√≥n de la operaci√≥n editada
                Array.from(this.processedOperations).forEach(key => {
                    if (key.startsWith(operationKeyPattern)) {
                        this.processedOperations.delete(key);
                    }
                });
                
                this.addNotification('info', 'Operaci√≥n Modificada', 
                    `Se edit√≥ la operaci√≥n de ${operation.usuario} (Ref: ${operation.referencia || 'N/A'})`, {
                    usuario: operation.usuario,
                    referencia: operation.referencia || 'N/A'
                });
                
                this.analyzeCurrentState();
            }

            onOperationsRecalculated() {
                // Cuando se recalcula todo (ej. por FIFO), limpiamos el estado del IA para un re-an√°lisis completo
                this.processedOperations.clear();
                this.lastLotStates.clear();
                this.lastOperationCount = 0;
                this.analyzeCurrentState();
                this.addNotification('info', 'Sistema Recalculado', 'Todas las operaciones han sido re-analizadas.');
            }

            resetDaily() {
                // Limpiar notificaciones y estado para el nuevo d√≠a
                this.notifications = [];
                this.alerts = [];
                this.processedOperations.clear();
                this.lastLotStates.clear();
                this.lastOperationCount = 0;
                this.renderNotifications();
                this.updateBadge();
                this.addNotification('info', 'Nuevo D√≠a', 'El sistema ha sido reiniciado para el d√≠a de hoy.');
            }
        }

        // Funciones de control del Centro de Operaciones IA
        function clearNotifications() {
            if (window.aiCenter) {
                const today = new Date().toISOString().split('T')[0];
                // Filtrar solo las notificaciones de hoy para limpiar
                window.aiCenter.notifications = window.aiCenter.notifications.filter(n => n.date !== today);
                window.aiCenter.alerts = window.aiCenter.alerts.filter(a => a.date !== today);
                window.aiCenter.renderNotifications();
                window.aiCenter.updateBadge();
                
                // Tambi√©n limpiar los datos procesados para el d√≠a actual en localStorage
                localStorage.removeItem(`aiStoredData_${today}`);
                window.aiCenter.processedOperations.clear();
                window.aiCenter.lastLotStates.clear();
                window.aiCenter.lastOperationCount = 0;
            }
        }

        function toggleAISettings() {
            if (window.aiCenter) {
                const brechaMin = prompt('Brecha m√≠nima (%) para alerta de "Brecha Baja":', window.aiCenter.alertThresholds.brechaMin);
                const brechaMax = prompt('Brecha m√°xima (%) para alerta de "Oportunidad: Brecha Alta":', window.aiCenter.alertThresholds.brechaMax);
                const muchoLotes = prompt('N√∫mero de lotes activos para alerta de "Muchos Lotes Activos":', window.aiCenter.alertThresholds.muchoLotes);
                const recompraCritica = prompt('Umbral de recompra cr√≠tica (USDC):', window.aiCenter.alertThresholds.recompraCritica);
                const reventaCritica = prompt('Umbral de reventa cr√≠tica (USDC):', window.aiCenter.alertThresholds.reventaCritica);
                
                if (brechaMin !== null) window.aiCenter.alertThresholds.brechaMin = parseFloat(brechaMin) || 2;
                if (brechaMax !== null) window.aiCenter.alertThresholds.brechaMax = parseFloat(brechaMax) || 4;
                if (muchoLotes !== null) window.aiCenter.alertThresholds.muchoLotes = parseInt(muchoLotes) || 3;
                if (recompraCritica !== null) window.aiCenter.alertThresholds.recompraCritica = parseFloat(recompraCritica) || 100;
                if (reventaCritica !== null) window.aiCenter.alertThresholds.reventaCritica = parseFloat(reventaCritica) || 100;
                
                window.aiCenter.addNotification('info', 'Configuraci√≥n Actualizada', 
                    'Los par√°metros de alerta han sido modificados');
            }
        }

        // Inicializar el Centro de Operaciones IA
        document.addEventListener('DOMContentLoaded', function() {
            window.aiCenter = new AIOperationsCenter();
            
            // Limpiar datos antiguos al inicio de cada d√≠a
            const today = new Date().toISOString().split('T')[0];
            const lastDateKey = 'aiLastProcessedDate';
            const lastProcessedDate = localStorage.getItem(lastDateKey);
            
            if (lastProcessedDate && lastProcessedDate !== today) {
                window.aiCenter.resetDaily();
                localStorage.setItem(lastDateKey, today); // Actualizar la fecha de √∫ltimo procesamiento
            } else if (!lastProcessedDate) {
                localStorage.setItem(lastDateKey, today); // Si no existe, establecerla
            }
        });

        // Exponer funciones globales para integraci√≥n
        window.AIOperationsCenter = AIOperationsCenter;
        
        window.notifyAINewOperation = function(operation) {
            if (window.aiCenter) {
                window.aiCenter.onOperationAdded(operation);
            }
        };
        
        window.notifyAIEditOperation = function(operation) {
            if (window.aiCenter) {
                window.aiCenter.onOperationEdited(operation);
            }
        };

        window.notifyAIRecalculation = function() {
            if (window.aiCenter) {
                window.aiCenter.onOperationsRecalculated();
            }
        };
    </script>
</body>
</html>
